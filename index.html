<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 배우 정보</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        #actors-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .actor-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .actor-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
        }
        .actor-name {
            font-size: 1.4em;
            margin-bottom: 5px;
            color: #555;
        }
        .actor-role {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 15px;
        }
        .message-section {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            text-align: left;
        }
        .message-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #444;
        }
        .message-list {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
            max-height: 150px; /* 메시지 목록 스크롤 가능하게 */
            overflow-y: auto;
            border: 1px solid #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .message-list li {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
            font-size: 0.9em;
            line-height: 1.4;
        }
        .message-list li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .message-list strong {
            color: #222;
        }
        .message-list .timestamp {
            font-size: 0.8em;
            color: #999;
            display: block;
            margin-top: 2px;
        }
        .message-form input,
        .message-form textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .message-form button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
        }
        .message-form button:hover {
            background-color: #0056b3;
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            #actors-container {
                grid-template-columns: 1fr; /* 모바일에서 한 열로 */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>오늘의 배우 정보</h1>
        <div id="actors-container">
            <p>배우 정보를 불러오는 중입니다...</p>
        </div>
    </div>

    <script>
        // 현재 날짜를 YYYY-MM-DD 형식으로 반환하는 함수
        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

       
        // 초기 데이터 (실제 데이터에 맞게 수정)
        // 이 데이터는 initializeServerData 함수가 POST 요청을 보낼 때 사용됩니다.
        const defaultActorsData = {
            '2025-07-18': [
                 { id: 1, name: '정찬우', role: '에반', photo: 'https://i.postimg.cc/2yY61TtF/image.jpg', messages: [] },
                { id: 2, name: '황시현', role: '하이디', photo: 'https://i.postimg.cc/QNgC2GB6/image.jpg', messages: [] },
                { id: 3, name: '구태본', role: '코너', photo: 'https://i.postimg.cc/SN79fY7x/image.jpg', messages: [] },
                 { id: 4, name: '오소정', role: '조이', photo: 'https://i.postimg.cc/Nf4yHqBy/image.jpg', messages: [] },
                { id: 5, name: '김백진', role: '래리', photo: 'https://i.postimg.cc/Pqcv5Wh2/image.jpg', messages: [] },
                { id: 6, name: '김수정', role: '신시아', photo: 'https://i.postimg.cc/sxCBp3MW/image.jpg', messages: [] },
                { id: 7, name: '강민욱', role: '자레드', photo: 'https://i.postimg.cc/fbk0s24V/image.jpg', messages: [] },
 		        { id: 8, name: '박현서', role: '알라나', photo: 'https://i.postimg.cc/dtvk3tPP/image.jpg', messages: [] },
 		        { id: 9, name: '곽다영', role: '마리', photo: 'https://i.postimg.cc/L8xZrdWd/image.jpg', messages: [] },
 		        { id: 10, name: '김영인', role: '주디', photo: 'https://i.postimg.cc/prQmC3j6/image.jpg', messages: [] },
                { id: 11, name: '나명건', role: '에릭', photo: 'https://i.postimg.cc/1RDVyVdr/image.jpg', messages: [] },
		        { id: 12, name: '이용철', role: '올리버', photo: 'https://i.postimg.cc/QdYHfQBh/image.jpg', messages: [] },
                { id: 13, name: '정민경', role: '사라', photo: 'https://i.postimg.cc/LsrhpmBW/image.jpg', messages: [] },
                { id: 14, name: '조한', role: '조쉬', photo:'https://i.postimg.cc/PrtJh3Yd/image.jpg',messages: [] },
		        { id: 15, name: '정윤호', role: '연출',  photo: 'https://i.postimg.cc/bvGdWZbb/image.jpg', messages: [] },
            ],
            '2025-07-19': [
                 { id: 1, name: '정찬우', role: '에반', photo: 'https://i.postimg.cc/2yY61TtF/image.jpg', messages: [] },
                { id: 2, name: '김수빈', role: '하이디', photo: 'https://i.postimg.cc/SsM22nxq/image.jpg', messages: [] },
                { id: 3, name: '구태본', role: '코너', photo: 'https://i.postimg.cc/SN79fY7x/image.jpg', messages: [] },
                 { id: 4, name: '오소정', role: '조이', photo: 'https://i.postimg.cc/Nf4yHqBy/image.jpg', messages: [] },
                { id: 5, name: '김백진', role: '래리', photo: 'https://i.postimg.cc/Pqcv5Wh2/image.jpg', messages: [] },
                { id: 6, name: '이서진', role: '신시아', photo: 'https://i.postimg.cc/QddFg4df/image.jpg', messages: [] },
 		        { id: 7, name: '강민욱', role: '자레드', photo: 'https://i.postimg.cc/fbk0s24V/image.jpg', messages: [] },
 		        { id: 8, name: '김두현', role: '알라나', photo: 'https://i.postimg.cc/CxhqPMmH/image.jpg', messages: [] },
 		        { id: 9, name: '곽다영', role: '마리', photo: 'https://i.postimg.cc/L8xZrdWd/image.jpg', messages: [] },
 		        { id: 10, name: '김영인', role: '주디', photo: 'https://i.postimg.cc/prQmC3j6/image.jpg', messages: [] },
                { id: 11, name: '나명건', role: '에릭', photo: 'https://i.postimg.cc/1RDVyVdr/image.jpg', messages: [] },
		        { id: 12, name: '이용철', role: '올리버', photo: 'https://i.postimg.cc/QdYHfQBh/image.jpg', messages: [] },
                { id: 13, name: '정민경', role: '사라', photo: 'https://i.postimg.cc/LsrhpmBW/image.jpg', messages: [] },
                { id: 14, name: '조한', role: '조쉬', photo:'https://i.postimg.cc/PrtJh3Yd/image.jpg',messages: [] },
		        { id: 15, name: '정윤호', role: '연출',  photo: 'https://i.postimg.cc/bvGdWZbb/image.jpg', messages: [] },
            ]
        };

        // 초기 데이터 주입 함수 (POST 요청 사용)
        async function initializeServerData() {
            try {
                console.log('초기 데이터 초기화를 시도합니다.');
                // server.js의 라우트와 일치하도록 /api/init-data 경로를 추가
                const response = await fetch(`${BASE_URL}/api/init-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(defaultActorsData) // 초기 데이터를 JSON 본문에 담아 보냄
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                console.log('초기 데이터 초기화 성공:', await response.text());
            } catch (error) {
                console.error('초기 데이터 초기화 실패:', error);
                // 에러 발생 시 사용자에게 메시지 표시
                const actorsContainer = document.getElementById('actors-container');
                if (actorsContainer) {
                    actorsContainer.innerHTML = '<p style="color: red;">초기 데이터 로딩에 실패했습니다. (콘솔 확인)</p>';
                }
            }
        }

        // 배우 정보를 로드하는 함수 (특정 날짜의 데이터 요청)
        async function loadActors() {
            try {
                const currentDate = getCurrentDate(); // 현재 날짜 가져오기
                console.log(`배우 정보를 로드합니다. 날짜: ${currentDate}`);
                // server.js의 라우트와 일치하도록 /api/actors/:date 경로를 추가
                const response = await fetch(`${BASE_URL}/api/actors/${currentDate}`); 

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const actors = await response.json();
                console.log('불러온 배우 데이터:', actors);

                const actorsContainer = document.getElementById('actors-container');
                if (!actorsContainer) {
                    console.error("actors-container 요소를 찾을 수 없습니다.");
                    return;
                }
                actorsContainer.innerHTML = ''; // 기존 내용 지우기

                if (actors.length === 0) {
                    actorsContainer.innerHTML = '<p>오늘 날짜의 배우 정보가 없습니다. 초기 데이터를 로드하거나 다른 날짜를 선택해주세요.</p>';
                    return;
                }

                actors.forEach(actor => {
                    const actorCard = document.createElement('div');
                    actorCard.className = 'actor-card';
                    // actor._id는 MongoDB에서 자동 생성되는 ID입니다.
                    actorCard.innerHTML = `
                        <img src="${actor.photo}" alt="${actor.name}" class="actor-photo">
                        <h3 class="actor-name">${actor.name}</h3>
                        <p class="actor-role">${actor.role}</p>
                        <div class="message-section">
                            <h4>메시지</h4>
                            <ul class="message-list" id="messages-${actor._id}">
                                ${actor.messages.map(msg => `<li><strong>${msg.author}:</strong> ${msg.text} <span class="timestamp">(${msg.timestamp})</span></li>`).join('')}
                            </ul>
                            <form class="message-form" data-actor-id="${actor._id}">
                                <input type="text" placeholder="작성자 이름" required>
                                <textarea placeholder="메시지 내용" required></textarea>
                                <button type="submit">메시지 남기기</button>
                            </form>
                        </div>
                    `;
                    actorsContainer.appendChild(actorCard);
                });

                // 메시지 폼 제출 이벤트 리스너 추가
                document.querySelectorAll('.message-form').forEach(form => {
                    form.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const actorId = form.dataset.actorId; // MongoDB의 _id 사용
                        const author = form.querySelector('input').value;
                        const text = form.querySelector('textarea').value;

                        try {
                            // server.js의 라우트와 일치하도록 /api/actors/:date/:actorId/messages 경로를 추가
                            const response = await fetch(`${BASE_URL}/api/actors/${currentDate}/${actorId}/messages`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ author, text })
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                            }

                            const newMessage = await response.json();
                            const messageList = document.getElementById(`messages-${actorId}`);
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `<strong>${newMessage.author}:</strong> ${newMessage.text} <span class="timestamp">(${newMessage.timestamp})</span>`;
                            messageList.appendChild(listItem);

                            // 폼 필드 초기화
                            form.querySelector('input').value = ''; 
                            form.querySelector('textarea').value = '';
                        } catch (error) {
                            console.error('메시지 전송 실패:', error);
                            alert('메시지 전송에 실패했습니다.');
                        }
                    });
                });

            } catch (error) {
                console.error('배우 정보 로드 실패:', error);
                const actorsContainer = document.getElementById('actors-container');
                if (actorsContainer) {
                    actorsContainer.innerHTML = '<p style="color: red;">배우 정보를 불러오지 못했습니다. (콘솔 확인)</p>';
                }
            }
        }

        // 페이지 로드 시 실행되는 함수
        window.onload = async function() {
            // 중요: 초기 데이터가 데이터베이스에 한 번도 주입되지 않았다면 이 라인의 주석을 해제하고 배포하세요.
            // 데이터가 성공적으로 주입된 것을 확인하면 다시 주석 처리하거나 제거하는 것이 좋습니다.
            await initializeServerData(); 
            
            await loadActors(); // 배우 정보 로드
        };
    </script>
</body>
</html>